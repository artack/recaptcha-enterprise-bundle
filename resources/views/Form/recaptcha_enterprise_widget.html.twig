{% block recaptcha_enterprise_widget %}
    {{ block('form_widget_simple') }}

    {% if form.vars.enabled -%}
        <script src="https://www.google.com/recaptcha/enterprise.js?render={{ form.vars.site_key }}" async defer {% if form.vars.script_csp_nonce %}nonce="{{ form.vars.script_csp_nonce }}"{% endif %}></script>
        <script {% if form.vars.script_csp_nonce %}nonce="{{ form.vars.script_csp_nonce }}"{% endif %}>
            const recaptchaTokenField = document.getElementById('{{ form.vars.id }}');
            const recaptchaForm = recaptchaTokenField.closest('form');

            if (recaptchaForm) {
                recaptchaForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    grecaptcha.enterprise.ready(async () => {
                        recaptchaTokenField.value = await grecaptcha.enterprise.execute('{{ form.vars.site_key }}', {action: '{{ form.vars.action_name }}'});
                        recaptchaForm.submit();
                    });
                });
            }
        </script>
    {%- endif %}
{% endblock %}
